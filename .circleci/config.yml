# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
parameters:
  slack_notify:
    type: boolean
    default: false
orbs:
  slack: circleci/slack@4.10.1
  allure: ayte/allure@0.1.3
  node: circleci/node@5.0.2
  openjdk-install: cloudesire/openjdk-install@1.2.3
jobs:
  playwright-test:
    docker:
      - image: mcr.microsoft.com/playwright:v1.22.0-focal
    environment:
      NODE_ENV: development
    steps:
      - add_ssh_keys:
          fingerprints:
            - "d6:36:58:af:d8:57:47:db:30:77:62:ea:40:f7:03:03"
      - checkout
      # - run: npm install
      # - run: npm install -g docker 
      # - run: docker exec -u root -t -i container_id /bin/bash
      # - run: apt-get update
      # - run: apt-get -y install sudo
      # - run: sudo apt install openjdk-8-jdk -y
      - run: export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      - run: export PATH=$PATH:$JAVA_HOME/bin
      - run: npm i -D playwright @playwright/test
      # - run: npm i -D experimental-allure-playwright 
      # - run: npm i -D allure-commandline
      - when:
          condition: <<pipeline.parameters.slack_notify>>
          steps:
          - slack/notify:
              channel: general
              custom: |
                {
                  "blocks": [
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "plain_text",
                          "text": "Starting Automation Run!"
                        }
                      ]
                    }
                  ]
                }
              event: always
      - run:
          name: Run tests
          command: | 
             npx playwright test --reporter=experimental-allure-playwright
      - run:
          name: Generate allure report with history
          command: |
            git clone -b gh-pages git@github.com:anneH/allure-playwright-example.git gh-pages
            npx allure generate ./allure-results --clean
            cp -R ./gh-pages/history ./allure-results
            npx allure generate ./allure-results --clean -o allure-report
          when: always 
      - run:
          name: Publish Allure Report
          command: | 
              npm install gh-pages -g
              git config user.email "anne.h@mailfence.com"
              git config user.name "anneH"
              gh-pages --dist ./allure-report
          when: always
      - store_artifacts:
           path: allure-report
     
# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  version: 2
  e2e-test-workflow:
    jobs:
      - playwright-test:
           context: slack
           post-steps:
             - when:
                condition: <<pipeline.parameters.slack_notify>>
                steps:
                 - slack/notify:
                    channel: general
                    mentions: "<https://anneh.github.io/allure-playwright-example/|Test Results> or go to 'View job' > Artifacts > allure-report/index.html"      
    
   
           
          #  filters:
          #    branches:
          #      only:
          #        - <<pipeline.parameters.branch>>