# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs

executors:
  my-executor:
     docker:
      - image: mcr.microsoft.com/playwright:v1.22.0-focal
     environment:
      NODE_ENV: development
      working_directory: ~/.
     
jobs:
  playwright-test:
    executor: my-executor
    steps:
      - run: mkdir -p workspace
      - add_ssh_keys:
          fingerprints:
            - "d6:36:58:af:d8:57:47:db:30:77:62:ea:40:f7:03:03"
      - checkout:
            path: ~/allure-playwright-example
      - run: npm install npm@latest -g
      - run: npm install -g docker 
      - run: docker exec -u root -t -i container_id /bin/bash
      - run:
          name: Install Java
          command: |
           apt-get update 
           apt-get -y install sudo
           sudo apt install openjdk-8-jdk -y
           export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
           export PATH=$PATH:$JAVA_HOME/bin
      - run: 
          name: Install Playwright
          command: |
           npm i -D playwright @playwright/test
           npm i -D experimental-allure-playwright 
      - run:
          name: Install Allure
          command: npm i -D allure-commandline
      - run: 
          name: Generate Allure report
          command: |
           npx playwright test --reporter=experimental-allure-playwright ||true
           npx allure generate ./allure-results --clean
      - persist_to_workspace:
          # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
          # taken to be the root directory of the workspace.
          root: workspace
          # Must be relative path from root
          paths:
            - work
  
  publish-report:
    executor: my-executor
    steps:
      - attach_workspace:
          # Must be absolute path or relative path from working_directory
          at: /workspace/work
      - run:
          name: Install Github Pages
          command: npm install gh-pages -g
      - run:
          name: Publish report to Github Pages
          command: gh-pages --dist ./allure-report

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  e2e-test-workflow:
    jobs:
      - playwright-test
      - publish-report:
          requires:
            - playwright-test
